#  BGP. Фильтрация

## Цель

- Настроить фильтрацию для офисе Москва
- Настроить фильтрацию для офисе С.-Петербург

##  Задание:

1. Настроить фильтрацию в офисе Москва так, чтобы не появилось транзитного трафика(As-path).
2. Настроить фильтрацию в офисе С.-Петербург так, чтобы не появилось транзитного трафика(Prefix-list).
3. Настроить провайдера Киторн так, чтобы в офис Москва отдавался только маршрут по умолчанию.
4. Настроить провайдера Ламас так, чтобы в офис Москва отдавался только маршрут по умолчанию и префикс офиса С.-Петербург.
5. Все сети в лабораторной работе должны иметь IP связность.
6. План работы и изменения зафиксированы в документации.

### 1. Общие положения.

#### 1.1 Схема сети

![](img/lab12.png)

#### 1.2 Таблица адресации


| Device        | Interface     | IP address      | Subnet mask     | Default gateway |
| ------------- | ------------- | --------------- | --------------- | --------------- |
| R14           | e0/0          | 10.0.0.1        | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.7        | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.8        | 255.255.255.254 | N/A             |
|               | e0/3          | 10.0.0.10       | 255.255.255.254 | N/A             |
|               | e1/0          | 10.0.0.46       | 255.255.255.254 | N/A             |
| R15           | e0/0          | 10.0.0.5        | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.3        | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.12       | 255.255.255.254 | N/A             |
|               | e0/3          | 10.0.0.14       | 255.255.255.254 | N/A             |
|               | e1/0          | 10.0.0.47       | 255.255.255.254 | N/A             |
| R18           | e0/0          | 10.0.0.17       | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.21       | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.22       | 255.255.255.254 | N/A             |
|               | e0/3          | 10.0.0.24       | 255.255.255.254 | N/A             |
| R19           | e0/0          | 10.0.0.11       | 255.255.255.254 | N/A             |
|               | lo1           | 10.1.0.19       | 255.255.255.255 | N/A             |
| R20           | e0/0          | 10.0.0.15       | 255.255.255.254 | N/A             |
| R21           | e0/0          | 10.0.0.13       | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.26       | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.28       | 255.255.255.254 | N/A             |
| R22           | e0/0          | 10.0.0.9        | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.27       | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.30       | 255.255.255.254 | N/A             |
| R24           | e0/0          | 10.0.0.29       | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.36       | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.35       | 255.255.255.254 | N/A             |
|               | e0/3          | 10.0.0.23       | 255.255.255.254 | N/A             |
|               | lo1           | 10.1.0.24       | 255.255.255.255 | N/A             |
| R25           | e0/0          | 10.0.0.33       | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.38       | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.40       | 255.255.255.254 | N/A             |
|               | e0/3          | 10.0.0.42       | 255.255.255.254 | N/A             |
|               | lo1           | 10.1.0.25       | 255.255.255.255 | N/A             |
| R26           | e0/0          | 10.0.0.37       | 255.255.255.254 | N/A             |
|               | e0/1          | 10.0.0.44       | 255.255.255.254 | N/A             |
|               | e0/2          | 10.0.0.41       | 255.255.255.254 | N/A             |
|               | e0/3          | 10.0.0.25       | 255.255.255.254 | N/A             |

### 2. Настройка BGP.
#### 2.1 Настроить фильтрацию в офисе Москва так, чтобы не появилось транзитного трафика(As-path).
- Проверяю на R22, с какими AS_PATH приходят объявления от 10.0.0.8
```
R22#show ip bgp | inc 10.0.0.8
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
 *   10.0.0.8/31      10.0.0.26                              0 301 1001 i
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 i
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *   10.0.0.16/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 2042 ?
 *   10.0.0.20/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 2042 ?
 *   10.0.0.22/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   10.0.0.24/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 2042 ?
 *   10.0.0.26/31     10.0.0.8                               0 1001 1001 1001 1001 301 ?
 *   10.0.0.28/31     10.0.0.8                               0 1001 1001 1001 1001 301 ?
 *   10.0.0.30/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 i
 *   10.0.0.32/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   10.0.0.34/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   10.0.0.36/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   10.0.0.38/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   10.0.0.40/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   10.0.0.42/31     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
 *   10.1.0.24/32     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   10.1.0.25/32     10.0.0.8                               0 1001 1001 1001 1001 301 520 ?
 *   192.168.102.0    10.0.0.8                               0 1001 1001 1001 1001 301 520 i

```
- Для реализации фильтрации создаю на R14 и R15 правило ip as-path access-list и применяю на соседа.
```
R14(config)#ip as-path access-list 1 permit ^$
R14(config)#router bgp 1001
R14(config-router)#neighbor 10.0.0.9 filter-list 1 out

```
- Проверяю на R22 теперь.
```
R22#show ip bgp | inc 10.0.0.8
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
 *   10.0.0.8/31      10.0.0.26                              0 301 1001 i
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 i
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *                    10.0.0.8                               0 1001 1001 1001 1001 ?
 *                    10.0.0.8                 0             0 1001 1001 1001 1001 ?
R22#
```
- Остался только маршрут на сам R14 через Ламас.
- Повторяю то же самое на R15.

#### 2.2 Настроить фильтрацию в офисе С.-Петербург так, чтобы не появилось транзитного трафика(Prefix-list).
- Что сейчас получает R24 из AS 2042:
```
R24#show ip bgp | inc 2042
 * i 10.0.0.16/31     10.0.0.24                0    100      0 2042 ?
 *>                   10.0.0.22                0             0 2042 ?
 * i 10.0.0.20/31     10.0.0.24                0    100      0 2042 ?
 *>                   10.0.0.22                0             0 2042 ?
 *   10.0.0.22/31     10.0.0.22                0             0 2042 i
 * i 10.0.0.24/31     10.0.0.24                0    100      0 2042 ?
 *>                   10.0.0.22                0             0 2042 ?
```
- Допустим, что я хочу отправлять только 10.0.0.16/31
```
R18(config)#ip prefix-list NO-TRANSIT seq 5 permit 10.0.0.16/31

R18(config-router)#router bgp 2042
R18(config-router)#neighbor 10.0.0.23 prefix-list NO-TRANSIT out
R18(config-router)#neighbor 10.0.0.25 prefix-list NO-TRANSIT out

```
- Что на R24:
```
R24#show ip bgp | inc 2042
* i 10.0.0.16/31     10.0.0.24                0    100      0 2042 ?
*>                   10.0.0.22                0             0 2042 ?
```
#### 2.3 Настроить провайдера Киторн так, чтобы в офис Москва отдавался только маршрут по умолчанию.
